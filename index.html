<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Neon Star Racer | Precision Survival</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        :root { --pink: #ff00ff; --cyan: #00e0ff; --red: #ff3131; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; overflow: hidden; height: 100vh; display: flex; justify-content: center; align-items: center; }
        
        #gameContainer {
            position: relative;
            width: 100vw; height: 100vh;
            max-width: 500px; max-height: 900px;
            border: 4px solid var(--cyan);
            background: #05050a;
            touch-action: none;
        }

        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 20; padding: 20px; display: flex; justify-content: space-between; font-family: 'VT323', monospace; }
        .stat { font-size: 2rem; text-shadow: 0 0 10px rgba(0,224,255,0.5); }
        
        .overlay { 
            position: absolute; inset: 0; z-index: 50; background: rgba(0,0,0,0.92);
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; 
            padding: 20px;
        }
        
        .btn {
            background: none; border: 2px solid var(--pink); color: var(--pink);
            padding: 15px 40px; font-family: 'VT323', monospace; font-size: 2rem;
            cursor: pointer; box-shadow: 0 0 15px var(--pink); margin: 20px;
            transition: all 0.2s;
        }
        .btn:hover { background: var(--pink); color: #000; box-shadow: 0 0 25px var(--pink); }

        #winOverlay h1 { color: var(--cyan); font-size: 3.2rem; margin-bottom: 15px; text-shadow: 0 0 20px var(--cyan); }
        #winOverlay p { color: #fff; font-size: 1.8rem; margin-bottom: 30px; }

        #videoOverlay { background: #000; }
        #skipBtn {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,0,0,0.6); border: 2px solid var(--cyan);
            color: var(--cyan); padding: 10px 20px; font-size: 1.5rem;
            z-index: 100; cursor: pointer;
        }

        #bgAudioContainer {
            position: absolute; inset: 0; pointer-events: none; z-index: 1; opacity: 0;
        }
        #bgPlayer, #rewardPlayer { width: 100%; height: 100%; }
    </style>
</head>
<body>

<div id="gameContainer">
    <div id="ui">
        <div id="lives" class="stat" style="color:var(--red)">SHIELDS: 3</div>
        <div id="timer" class="stat" style="color:var(--cyan)">60s</div>
    </div>

    <div id="bgAudioContainer">
        <div id="bgPlayer"></div>
    </div>

    <div id="startOverlay" class="overlay">
        <h1 style="color:var(--cyan); font-size:3rem; margin-bottom:20px;">SURVIVE 60 SECONDS</h1>
        <button class="btn" onclick="startGame()">ENGINE START</button>
    </div>

    <div id="winOverlay" class="overlay" style="display:none;">
        <h1>You survived Tatooine Airspace</h1>
        <p style="color:var(--pink); font-size:2.2rem;">MISSION ACCOMPLISHED</p>
        <button class="btn" onclick="showRewardVideo()">Continue</button>
    </div>

    <div id="videoOverlay" class="overlay" style="display:none;">
        <button id="skipBtn" onclick="restart()">Skip</button>
        <div id="rewardPlayer"></div>
    </div>

    <canvas id="gameCanvas"></canvas>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    // ... (All Three.js scene, ship, bounds, spawnLaser, spawnAsteroid, update, move functions remain unchanged from previous version) ...

    let bgPlayer = null;
    let rewardPlayer = null;

    function onYouTubeIframeAPIReady() {
        bgPlayer = new YT.Player('bgPlayer', {
            height: '100%',
            width: '100%',
            videoId: 'o4uyUol4wBI',
            playerVars: {
                'autoplay': 0,
                'mute': 1,          // Start muted to allow reliable autoplay
                'controls': 0,
                'modestbranding': 1,
                'rel': 0,
                'showinfo': 0,
                'loop': 0,
                'playsinline': 1
            },
            events: {
                'onReady': onBgReady,
                'onAutoplayBlocked': onAutoplayBlocked,
                'onError': onPlayerError
            }
        });

        rewardPlayer = new YT.Player('rewardPlayer', {
            height: '100%',
            width: '100%',
            videoId: 'B7FMh3YtK_w',
            playerVars: {
                'autoplay': 0,
                'controls': 1,
                'modestbranding': 1,
                'rel': 0,
                'playsinline': 1
            },
            events: {
                'onReady': onRewardReady,
                'onStateChange': onRewardStateChange,
                'onError': onPlayerError
            }
        });
    }

    function onBgReady(event) {
        // Muted autoplay possible here, but we'll trigger play on gesture
    }

    function onRewardReady(event) {
        // Play on gesture in showRewardVideo
    }

    function onRewardStateChange(event) {
        if (event.data === YT.PlayerState.ENDED) {
            restart();
        }
    }

    function onAutoplayBlocked(event) {
        console.log('Autoplay blocked - needs user gesture');
        // Optional: Show a "Tap to enable audio" button if needed
    }

    function onPlayerError(event) {
        console.error('YouTube Player Error:', event.data);
        // Common codes: 100=video not found, 150=embedding restricted
    }

    function startGame() {
        gameActive = true; lives = 3; timeLeft = 60;
        livesEl.innerText = `SHIELDS: 3`;
        timerEl.innerText = `60s`;
        startOverlay.style.display = 'none';
        winOverlay.style.display = 'none';
        videoOverlay.style.display = 'none';

        if (bgPlayer) {
            bgPlayer.playVideo();  // Should work muted
            bgPlayer.unMute();     // Attempt unmute right after gesture (often succeeds)
        }

        // ... rest of startGame (clear obstacles, timerInterval, requestAnimationFrame(update)) ...
    }

    function showRewardVideo() {
        winOverlay.style.display = 'none';
        videoOverlay.style.display = 'flex';

        if (rewardPlayer) {
            rewardPlayer.unMute();  // Ensure unmuted
            rewardPlayer.playVideo();
        }
    }

    function endGame(won) {
        gameActive = false;
        clearInterval(timerInterval);

        if (bgPlayer) bgPlayer.pauseVideo();

        if (won) {
            winOverlay.style.display = 'flex';
        } else {
            alert("SHIELDS DEPLETED - GAME OVER");
            restart();
        }
    }

    function restart() {
        gameActive = false;
        clearInterval(timerInterval);

        if (bgPlayer) bgPlayer.pauseVideo();
        if (rewardPlayer) rewardPlayer.pauseVideo();

        location.reload();
    }

    // ... (resize listener, etc.) ...
</script>
</body>
</html>
