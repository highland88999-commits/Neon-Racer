<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Neon Star Racer | Precision Survival</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        :root { --pink: #ff00ff; --cyan: #00e0ff; --red: #ff3131; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; overflow: hidden; height: 100vh; display: flex; justify-content: center; align-items: center; }
        #gameContainer { position: relative; width: 100vw; height: 100vh; max-width: 500px; max-height: 900px; border: 4px solid var(--cyan); background: #05050a; touch-action: none; }
        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 20; padding: 20px; display: flex; justify-content: space-between; font-family: 'VT323', monospace; }
        .stat { font-size: 2rem; text-shadow: 0 0 10px rgba(0,224,255,0.5); }
        .overlay { position: absolute; inset: 0; z-index: 50; background: rgba(0,0,0,0.92); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        .btn { background: none; border: 2px solid var(--pink); color: var(--pink); padding: 15px 40px; font-family: 'VT323', monospace; font-size: 2rem; cursor: pointer; box-shadow: 0 0 15px var(--pink); margin: 20px; transition: all 0.2s; }
        .btn:hover { background: var(--pink); color: #000; box-shadow: 0 0 25px var(--pink); }
        #winOverlay h1 { color: var(--cyan); font-size: 3.2rem; margin-bottom: 15px; text-shadow: 0 0 20px var(--cyan); }
        #winOverlay p { color: #fff; font-size: 1.8rem; margin-bottom: 30px; }
        #videoOverlay { background: #000; position: relative; }
        #rewardVideo { width: 100%; height: 100%; }
        .control-btn { position: absolute; background: rgba(0,0,0,0.7); border: 2px solid var(--cyan); color: var(--cyan); padding: 12px 24px; font-family: 'VT323', monospace; font-size: 1.6rem; cursor: pointer; z-index: 100; }
        #skipBtn { top: 20px; right: 20px; }
        #unmuteBtn { bottom: 20px; left: 20px; }
        #unmuteBtn.hidden { display: none; }
        canvas { display: block; width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="ui">
            <div id="lives" class="stat" style="color:var(--red)">SHIELDS: 3</div>
            <div id="timer" class="stat" style="color:var(--cyan)">60s</div>
        </div>
        <div id="bgAudioContainer" style="display:none;">
            <iframe id="bgAudioVideo" src="" frameborder="0"></iframe>
        </div>
        <div id="startOverlay" class="overlay">
            <h1 style="color:var(--cyan); font-size:3rem; margin-bottom:20px;">SURVIVE 60 SECONDS</h1>
            <button class="btn" onclick="startGame()">ENGINE START</button>
        </div>
        <div id="winOverlay" class="overlay" style="display:none;">
            <h1>MISSION ACCOMPLISHED</h1>
            <p style="color:var(--pink); font-size:2.2rem;">Tatooine Airspace Clear</p>
            <button class="btn" onclick="showRewardVideo()">Continue</button>
        </div>
        <div id="videoOverlay" class="overlay" style="display:none;">
            <button id="skipBtn" class="control-btn" onclick="restart()">Skip</button>
            <button id="unmuteBtn" class="control-btn">Unmute</button>
            <iframe id="rewardVideo" src="https://www.youtube.com/embed/B7FMh3YtK_w?autoplay=1&mute=1&enablejsapi=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
        <canvas id="gameCanvas"></canvas>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const container = document.getElementById('gameContainer');
        const timerEl = document.getElementById('timer');
        const livesEl = document.getElementById('lives');
        const startOverlay = document.getElementById('startOverlay');
        const winOverlay = document.getElementById('winOverlay');
        const videoOverlay = document.getElementById('videoOverlay');
        const bgAudioVideo = document.getElementById('bgAudioVideo');
        const unmuteBtn = document.getElementById('unmuteBtn');

        let gameActive = false, timeLeft = 60, lives = 3;
        let obstacles = [], asteroids = [], lastSpawn = 0, lastAsteroid = 0;
        let timerInterval;

        // --- THREE.JS SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000011);
        const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({canvas, antialias: true});
        renderer.setSize(container.clientWidth, container.clientHeight);
        
        // Ship is at Z=0, Camera is at Z=10
        camera.position.z = 10;

        // Lighting
        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        const sunLight = new THREE.PointLight(0xffddaa, 2, 1000);
        sunLight.position.set(50, 20, -100);
        scene.add(sunLight);

        // Environment
        const starGeo = new THREE.BufferGeometry();
        const starPos = new Float32Array(3000 * 3);
        for(let i=0; i<9000; i++) starPos[i] = (Math.random()-0.5) * 1000;
        starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
        const stars = new THREE.Points(starGeo, new THREE.PointsMaterial({color: 0xffffff, size: 0.5}));
        scene.add(stars);

        // Ship Model
        const ship = new THREE.Group();
        const bodyGeo = new THREE.BoxGeometry(1.2, 0.3, 1.5);
        const shipMat = new THREE.MeshPhongMaterial({color: 0x888888, shininess: 100});
        const shipBody = new THREE.Mesh(bodyGeo, shipMat);
        const wingGeo = new THREE.BoxGeometry(2.5, 0.1, 0.6);
        const shipWings = new THREE.Mesh(wingGeo, shipMat);
        ship.add(shipBody, shipWings);
        scene.add(ship);

        // --- MATH FOR MOVEMENT ---
        function getBounds() {
            // Calculate visible width/height at Z=0 (where the ship is)
            const vFOV = THREE.MathUtils.degToRad(camera.fov);
            const height = 2 * Math.tan(vFOV / 2) * camera.position.z;
            const width = height * camera.aspect;
            return { w: width, h: height };
        }
        let bounds = getBounds();

        // --- INPUT HANDLING ---
        function move(e) {
            if (!gameActive) return;
            if (e.cancelable) e.preventDefault();

            const rect = container.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;

            // Normalize mouse/touch position to -1 to +1
            const nx = ((touch.clientX - rect.left) / rect.width) * 2 - 1;
            const ny = -((touch.clientY - rect.top) / rect.height) * 2 + 1;

            // Direct mapping: Ship position = NormalizedCoord * HalfFrustumSize
            ship.position.x = nx * (bounds.w / 2);
            ship.position.y = ny * (bounds.h / 2);

            // Visual Polish: Bank the ship
            ship.rotation.z = -nx * 0.5;
            ship.rotation.x = -ny * 0.2;
        }

        container.addEventListener('mousemove', move);
        container.addEventListener('touchmove', move, {passive: false});
        container.addEventListener('touchstart', move, {passive: false});

        // --- GAME LOGIC ---
        function spawnLaser(now) {
            if (now - lastSpawn < 1500) return;
            lastSpawn = now;
            const laser = new THREE.Mesh(
                new THREE.BoxGeometry(bounds.w * 0.6, 0.2, 0.2),
                new THREE.MeshBasicMaterial({color: 0x00e0ff, transparent: true, opacity: 0.8})
            );
            laser.position.set((Math.random()-0.5)*5, (Math.random()-0.5)*bounds.h, -100);
            scene.add(laser);
            obstacles.push(laser);
        }

        function spawnAsteroid(now) {
            if (now - lastAsteroid < 4000) return;
            lastAsteroid = now;
            const ast = new THREE.Mesh(
                new THREE.SphereGeometry(1.5, 8, 8),
                new THREE.MeshPhongMaterial({color: 0x666666})
            );
            ast.position.set((Math.random()-0.5)*bounds.w, (Math.random()-0.5)*bounds.h, -120);
            scene.add(ast);
            asteroids.push(ast);
        }

        function update(now) {
            if (!gameActive) return;

            stars.rotation.z += 0.001;

            // Update Lasers
            for (let i = obstacles.length - 1; i >= 0; i--) {
                const o = obstacles[i];
                o.position.z += 1.5;
                if (o.position.z > 12) { scene.remove(o); obstacles.splice(i, 1); continue; }
                if (new THREE.Box3().setFromObject(ship).intersectsBox(new THREE.Box3().setFromObject(o))) {
                    hit();
                    scene.remove(o); obstacles.splice(i, 1);
                }
            }

            // Update Asteroids
            for (let i = asteroids.length - 1; i >= 0; i--) {
                const a = asteroids[i];
                a.position.z += 0.8;
                a.rotation.x += 0.02;
                if (a.position.z > 12) { scene.remove(a); asteroids.splice(i, 1); continue; }
                if (new THREE.Box3().setFromObject(ship).intersectsBox(new THREE.Box3().setFromObject(a))) {
                    hit();
                    scene.remove(a); asteroids.splice(i, 1);
                }
            }

            spawnLaser(now);
            spawnAsteroid(now);
            renderer.render(scene, camera);
            requestAnimationFrame(update);
        }

        function hit() {
            lives--;
            livesEl.innerText = `SHIELDS: ${lives}`;
            if (lives <= 0) endGame(false);
        }

        function startGame() {
            gameActive = true;
            lives = 3;
            timeLeft = 60;
            livesEl.innerText = 'SHIELDS: 3';
            timerEl.innerText = '60s';
            startOverlay.style.display = 'none';
            winOverlay.style.display = 'none';
            bgAudioVideo.src = 'https://www.youtube.com/embed/o4uyUol4wBI?autoplay=1';
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.innerText = `${timeLeft}s`;
                if (timeLeft <= 0) endGame(true);
            }, 1000);
            
            requestAnimationFrame(update);
        }

        function endGame(won) {
            gameActive = false;
            clearInterval(timerInterval);
            if (won) winOverlay.style.display = 'flex';
            else { alert("SHIP DESTROYED"); restart(); }
        }

        function showRewardVideo() {
            winOverlay.style.display = 'none';
            videoOverlay.style.display = 'flex';
        }

        function restart() { location.reload(); }

        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
            bounds = getBounds();
        });

        unmuteBtn.addEventListener('click', () => {
            let src = document.getElementById('rewardVideo').src;
            document.getElementById('rewardVideo').src = src.replace('&mute=1', '');
            unmuteBtn.classList.add('hidden');
        });
    </script>
</body>
</html>
