<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Neon Star Racer | Precision Survival 90</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        :root { --pink: #ff00ff; --cyan: #00e0ff; --red: #ff3131; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; overflow: hidden; height: 100vh; display: flex; justify-content: center; align-items: center; }
        #gameContainer { position: relative; width: 100vw; height: 100vh; max-width: 500px; max-height: 900px; border: 4px solid var(--cyan); background: #05050a; touch-action: none; }
        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 20; padding: 20px; display: flex; justify-content: space-between; font-family: 'VT323', monospace; }
        .stat { font-size: 2rem; text-shadow: 0 0 10px rgba(0,224,255,0.5); }
        .overlay { position: absolute; inset: 0; z-index: 50; background: rgba(0,0,0,0.92); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        .btn { background: none; border: 2px solid var(--pink); color: var(--pink); padding: 15px 40px; font-family: 'VT323', monospace; font-size: 2rem; cursor: pointer; box-shadow: 0 0 15px var(--pink); margin: 20px; transition: all 0.2s; }
        .btn:hover { background: var(--pink); color: #000; box-shadow: 0 0 25px var(--pink); }
        
        /* Hidden Music Player */
        #musicPlayer { position: absolute; top: -100px; left: -100px; width: 1px; height: 1px; pointer-events: none; }
        canvas { display: block; width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="musicPlayer"></div>

        <div id="ui">
            <div id="lives" class="stat" style="color:var(--red)">SHIELDS: 3</div>
            <div id="timer" class="stat" style="color:var(--cyan)">90s</div>
        </div>

        <div id="startOverlay" class="overlay">
            <h1 style="color:var(--cyan); font-size:3rem; margin-bottom:20px;">SURVIVE 90 SECONDS</h1>
            <button class="btn" onclick="startGame()">ENGINE START</button>
        </div>

        <div id="winOverlay" class="overlay" style="display:none;">
            <h1>MISSION ACCOMPLISHED</h1>
            <p style="color:var(--pink); font-size:2.2rem; font-family:'VT323';">Tatooine Airspace Clear</p>
            <button class="btn" onclick="location.reload()">REPLAY</button>
        </div>

        <canvas id="gameCanvas"></canvas>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // --- YOUTUBE API ---
        let player;
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('musicPlayer', {
                height: '1', width: '1',
                playerVars: {
                    'listType': 'playlist',
                    'list': 'PLN7QpbidlV6UPOHQoR9Vw3Bxq0Wj_DrCp',
                    'autoplay': 0, 'controls': 0
                }
            });
        }

        // --- GAME ENGINE ---
        const canvas = document.getElementById('gameCanvas');
        const container = document.getElementById('gameContainer');
        const timerEl = document.getElementById('timer');
        const livesEl = document.getElementById('lives');
        
        let gameActive = false, timeLeft = 90, lives = 3;
        let obstacles = [], asteroids = [], stars;
        let lastSpawn = 0, lastAsteroid = 0;
        let timerInterval;

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000011);
        const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({canvas, antialias: true});
        renderer.setSize(container.clientWidth, container.clientHeight);
        camera.position.z = 10;

        scene.add(new THREE.AmbientLight(0xffffff, 0.8));

        // Ship
        const ship = new THREE.Group();
        const shipMat = new THREE.MeshPhongMaterial({color: 0x888888, shininess: 100});
        ship.add(new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.3, 1.5), shipMat));
        ship.add(new THREE.Mesh(new THREE.BoxGeometry(2.5, 0.1, 0.6), shipMat));
        scene.add(ship);

        // Environment
        const starGeo = new THREE.BufferGeometry();
        const starPos = new Float32Array(3000 * 3);
        for(let i=0; i<9000; i++) starPos[i] = (Math.random()-0.5) * 1000;
        starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
        stars = new THREE.Points(starGeo, new THREE.PointsMaterial({color: 0xffffff, size: 0.5}));
        scene.add(stars);

        function getBounds() {
            const vFOV = THREE.MathUtils.degToRad(camera.fov);
            const height = 2 * Math.tan(vFOV / 2) * camera.position.z;
            return { w: height * camera.aspect, h: height };
        }
        let bounds = getBounds();

        // --- MOVEMENT ---
        function move(e) {
            if (!gameActive) return;
            if (e.cancelable) e.preventDefault();
            const rect = container.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;

            const nx = ((touch.clientX - rect.left) / rect.width) * 2 - 1;
            const ny = -((touch.clientY - rect.top) / rect.height) * 2 + 1;

            ship.position.x = nx * (bounds.w / 2);
            ship.position.y = ny * (bounds.h / 2);
            ship.rotation.z = -nx * 0.5;
            ship.rotation.x = -ny * 0.2;
        }

        container.addEventListener('mousemove', move);
        container.addEventListener('touchmove', move, {passive: false});
        container.addEventListener('touchstart', move, {passive: false});

        // --- LOGIC ---
        function spawnObstacles(now) {
            if (now - lastSpawn > 1400) {
                lastSpawn = now;
                const laser = new THREE.Mesh(new THREE.BoxGeometry(bounds.w * 0.6, 0.2, 0.2), new THREE.MeshBasicMaterial({color: 0x00e0ff}));
                laser.position.set((Math.random()-0.5)*5, (Math.random()-0.5)*bounds.h, -100);
                scene.add(laser);
                obstacles.push(laser);
            }
            if (now - lastAsteroid > 3500) {
                lastAsteroid = now;
                const ast = new THREE.Mesh(new THREE.SphereGeometry(1.5, 8, 8), new THREE.MeshPhongMaterial({color: 0x666666}));
                ast.position.set((Math.random()-0.5)*bounds.w, (Math.random()-0.5)*bounds.h, -120);
                scene.add(ast);
                asteroids.push(ast);
            }
        }

        function update(now) {
            if (!gameActive) return;
            stars.rotation.z += 0.001;

            [...obstacles, ...asteroids].forEach((obj, i) => {
                obj.position.z += (obj.geometry.type === 'BoxGeometry') ? 1.5 : 0.8;
                if (obj.position.distanceTo(ship.position) < 1.4) {
                    lives--;
                    livesEl.innerText = `SHIELDS: ${lives}`;
                    scene.remove(obj);
                    if (obj.geometry.type === 'BoxGeometry') obstacles.splice(obstacles.indexOf(obj), 1);
                    else asteroids.splice(asteroids.indexOf(obj), 1);
                    if (lives <= 0) endGame(false);
                } else if (obj.position.z > 12) {
                    scene.remove(obj);
                    if (obj.geometry.type === 'BoxGeometry') obstacles.splice(obstacles.indexOf(obj), 1);
                    else asteroids.splice(asteroids.indexOf(obj), 1);
                }
            });

            spawnObstacles(now);
            renderer.render(scene, camera);
            requestAnimationFrame(update);
        }

        function startGame() {
            gameActive = true;
            document.getElementById('startOverlay').style.display = 'none';

            // Music Initialization
            if (player && player.playVideoAt) {
                player.setShuffle(true);
                player.playVideoAt(Math.floor(Math.random() * 10));
                player.unMute();
                player.setVolume(50);
            }

            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.innerText = `${timeLeft}s`;
                if (timeLeft <= 0) endGame(true);
            }, 1000);

            requestAnimationFrame(update);
        }

        function endGame(won) {
            gameActive = false;
            clearInterval(timerInterval);
            if (player && player.stopVideo) player.stopVideo();
            if (won) document.getElementById('winOverlay').style.display = 'flex';
            else { alert("SHIP DESTROYED"); location.reload(); }
        }

        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
            bounds = getBounds();
        });
    </script>
</body>
</html>
