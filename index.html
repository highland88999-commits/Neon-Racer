<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Neon Star Racer | Absolute Lock</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        :root { --pink: #ff00ff; --cyan: #00e0ff; --red: #ff3131; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; overflow: hidden; height: 100vh; display: flex; justify-content: center; align-items: center; }
        
        #gameContainer {
            position: relative;
            width: 100vw; height: 100vh;
            max-width: 500px; max-height: 900px;
            border: 4px solid var(--cyan);
            background: #05050a;
            touch-action: none;
        }

        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 20; padding: 20px; display: flex; justify-content: space-between; font-family: 'VT323', monospace; }
        .stat { font-size: 2rem; text-shadow: 0 0 10px rgba(0,224,255,0.5); }
        .overlay { position: absolute; inset: 0; z-index: 50; background: rgba(0,0,0,0.92); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        
        .btn {
            background: none; border: 2px solid var(--pink); color: var(--pink);
            padding: 15px 40px; font-family: 'VT323', monospace; font-size: 2rem;
            cursor: pointer; box-shadow: 0 0 15px var(--pink); margin: 20px;
        }

        #rewardVideo { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>

<div id="gameContainer">
    <div id="ui">
        <div id="lives" class="stat" style="color:var(--red)">SHIELDS: 3</div>
        <div id="timer" class="stat" style="color:var(--cyan)">60s</div>
    </div>

    <div id="startOverlay" class="overlay">
        <h1 style="color:var(--cyan); font-family:'VT323'; font-size:3rem; margin-bottom:20px;">SURVIVE 60 SECONDS</h1>
        <button class="btn" onclick="startGame()">ENGINE START</button>
    </div>

    <div id="winOverlay" class="overlay" style="display:none;">
        <h1 style="color:var(--cyan); font-family:'VT323'; font-size:3rem;">MISSION COMPLETE</h1>
        <p style="color:white; font-family:'VT323'; font-size:1.5rem;">You survived the grid.</p>
        <button class="btn" onclick="showRewardVideo()">CONTINUE</button>
    </div>

    <div id="videoOverlay" class="overlay" style="display:none; background:#000; padding:0;">
        <button style="position:absolute; top:10px; right:10px; z-index:100; color:white; background:none; border:1px solid white; padding:5px;" onclick="restart()">SKIP</button>
        <iframe id="rewardVideo" src="" allow="autoplay"></iframe>
    </div>

    <canvas id="gameCanvas"></canvas>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    const canvas = document.getElementById('gameCanvas');
    const container = document.getElementById('gameContainer');
    const timerEl = document.getElementById('timer');
    const livesEl = document.getElementById('lives');
    const startOverlay = document.getElementById('startOverlay');
    const winOverlay = document.getElementById('winOverlay');
    const videoOverlay = document.getElementById('videoOverlay');

    let gameActive = false, timeLeft = 60, lives = 3, obstacles = [], lastSpawn = 0;
    let timerInterval = null;

    // Three.js
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    camera.position.z = 10;

    const ship = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(1, 0.3, 1.5), new THREE.MeshPhongMaterial({color: 0x555555}));
    const wingL = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 1.2), new THREE.MeshPhongMaterial({color: 0x222222}));
    wingL.position.set(-1.2, 0, 0.2); wingL.rotation.x = Math.PI/2;
    const wingR = wingL.clone(); wingR.position.x = 1.2;
    ship.add(body, wingL, wingR);
    scene.add(ship);
    scene.add(new THREE.AmbientLight(0xffffff, 1));

    // Locked Bounds Calculation
    function getBounds() {
        const vFOV = THREE.MathUtils.degToRad(camera.fov);
        const height = 2 * Math.tan(vFOV / 2) * camera.position.z;
        const width = height * camera.aspect;
        // Padding ensures the edges of the wings stay inside the box
        return { x: (width / 2) - 1.4, y: (height / 2) - 0.6 };
    }
    let bounds = getBounds();

    function spawnLaser(now) {
        if (now - lastSpawn < 1800) return; // Rhythm: roughly one every 1.8 seconds
        lastSpawn = now;

        const colors = [0xff00ff, 0x00e0ff, 0x39ff14, 0xffff00];
        const color = colors[Math.floor(Math.random() * colors.length)];
        const laser = new THREE.Mesh(
            new THREE.BoxGeometry(40, 0.3, 0.3), 
            new THREE.MeshBasicMaterial({color: color})
        );
        // Random Y position within the strict bounds
        laser.position.set(0, (Math.random() - 0.5) * bounds.y * 2, -100);
        scene.add(laser);
        obstacles.push(laser);
    }

    function update(now) {
        if (!gameActive) return;

        for (let i = obstacles.length - 1; i >= 0; i--) {
            const o = obstacles[i];
            o.position.z += 0.85; // Speed

            const shipBox = new THREE.Box3().setFromObject(ship);
            const laserBox = new THREE.Box3().setFromObject(o);
            
            if (shipBox.intersectsBox(laserBox)) {
                lives--;
                livesEl.innerText = `SHIELDS: ${lives}`;
                scene.remove(o);
                obstacles.splice(i, 1);
                if (lives <= 0) restart();
                continue;
            }

            if (o.position.z > 12) {
                scene.remove(o);
                obstacles.splice(i, 1);
            }
        }

        spawnLaser(now);
        renderer.render(scene, camera);
        requestAnimationFrame(update);
    }

    // THE ABSOLUTE LOCK
    const move = (e) => {
        if (!gameActive) return;
        const rect = container.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : e;
        
        // 0 to 1 mapping of finger on the screen
        const px = THREE.MathUtils.clamp((touch.clientX - rect.left) / rect.width, 0, 1);
        const py = THREE.MathUtils.clamp((touch.clientY - rect.top) / rect.height, 0, 1);

        // Map directly to 3D bounds
        ship.position.x = (px * 2 - 1) * bounds.x;
        ship.position.y = -(py * 2 - 1) * bounds.y;

        // Visual tilt
        ship.rotation.z = -ship.position.x * 0.1;
        ship.rotation.x = -ship.position.y * 0.05;
    };

    container.addEventListener('mousemove', move);
    container.addEventListener('touchmove', (e) => { e.preventDefault(); move(e); }, {passive:false});

    function startGame() {
        gameActive = true; lives = 3; timeLeft = 60;
        startOverlay.style.display = 'none';
        winOverlay.style.display = 'none';
        videoOverlay.style.display = 'none';
        livesEl.innerText = `SHIELDS: 3`;
        timerEl.innerText = `60s`;
        
        obstacles.forEach(o => scene.remove(o));
        obstacles = [];
        
        timerInterval = setInterval(() => {
            if (!gameActive) { clearInterval(timerInterval); return; }
            timeLeft--;
            timerEl.innerText = `${timeLeft}s`;
            if (timeLeft <= 0) {
                gameActive = false;
                winOverlay.style.display = 'flex';
            }
        }, 1000);
        requestAnimationFrame(update);
    }

    function showRewardVideo() {
        winOverlay.style.display = 'none';
        videoOverlay.style.display = 'flex';
        document.getElementById('rewardVideo').src = "https://www.youtube.com/embed/B7FMh3YtK_w?autoplay=1";
    }

    function restart() {
        gameActive = false;
        clearInterval(timerInterval);
        location.reload();
    }

    window.addEventListener('resize', () => {
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
        bounds = getBounds();
    });
</script>
</body>
</html>
