<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Neon Star Racer | Combat Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        :root { --pink: #ff00ff; --cyan: #00e0ff; --red: #ff3131; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; overflow: hidden; height: 100vh; display: flex; justify-content: center; align-items: center; }
        #gameContainer { position: relative; width: 100vw; height: 100vh; max-width: 500px; max-height: 900px; border: 4px solid var(--cyan); background: #05050a; touch-action: none; }
        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 20; padding: 20px; display: flex; justify-content: space-between; font-family: 'VT323', monospace; }
        .stat { font-size: 2rem; text-shadow: 0 0 10px rgba(0,224,255,0.5); }
        .overlay { position: absolute; inset: 0; z-index: 50; background: rgba(0,0,0,0.92); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        .btn { background: none; border: 2px solid var(--pink); color: var(--pink); padding: 15px 40px; font-family: 'VT323', monospace; font-size: 2rem; cursor: pointer; box-shadow: 0 0 15px var(--pink); margin: 20px; transition: all 0.2s; }
        .btn:hover { background: var(--pink); color: #000; box-shadow: 0 0 25px var(--pink); }
        
        /* FIRE BUTTON STYLES */
        #fireBtn {
            position: absolute;
            bottom: 40px;
            left: 20px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 0, 255, 0.2);
            border: 3px solid var(--pink);
            color: var(--pink);
            font-family: 'VT323', monospace;
            font-size: 1.5rem;
            z-index: 100;
            pointer-events: auto;
            display: none; /* Shown on start */
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px var(--pink);
        }
        #fireBtn:active { background: var(--pink); color: black; }

        #videoOverlay { background: #000; position: relative; }
        #rewardVideo { width: 100%; height: 100%; }
        canvas { display: block; width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="ui">
            <div id="lives" class="stat" style="color:var(--red)">SHIELDS: 3</div>
            <div id="score" class="stat" style="color:var(--cyan)">KILLS: 0</div>
        </div>

        <button id="fireBtn" ontouchstart="fireLaser()" onclick="fireLaser()">FIRE</button>

        <div id="startOverlay" class="overlay">
            <h1 style="color:var(--cyan); font-size:3rem; margin-bottom:20px;">PRECISION SURVIVAL</h1>
            <button class="btn" onclick="startGame()">ENGINE START</button>
        </div>

        <div id="winOverlay" class="overlay" style="display:none;">
            <h1>MISSION ACCOMPLISHED</h1>
            <button class="btn" onclick="restart()">Play Again</button>
        </div>

        <canvas id="gameCanvas"></canvas>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const container = document.getElementById('gameContainer');
        const livesEl = document.getElementById('lives');
        const scoreEl = document.getElementById('score');
        const fireBtn = document.getElementById('fireBtn');
        const startOverlay = document.getElementById('startOverlay');
        const winOverlay = document.getElementById('winOverlay');

        let gameActive = false, lives = 3, score = 0;
        let obstacles = [], enemies = [], bullets = [];
        let lastSpawn = 0, lastEnemy = 0;

        // --- THREE.JS SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000008);
        const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({canvas, antialias: true});
        renderer.setSize(container.clientWidth, container.clientHeight);
        camera.position.z = 10;

        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const sunLight = new THREE.PointLight(0xff00ff, 2, 100);
        sunLight.position.set(0, 0, 10);
        scene.add(sunLight);

        // Ship
        const ship = new THREE.Group();
        const shipMat = new THREE.MeshPhongMaterial({color: 0x00e0ff});
        const shipBody = new THREE.Mesh(new THREE.BoxGeometry(1, 0.2, 1.2), shipMat);
        const shipCabin = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.3, 0.5), new THREE.MeshPhongMaterial({color: 0xffffff}));
        shipCabin.position.y = 0.2;
        ship.add(shipBody, shipCabin);
        scene.add(ship);

        function getBounds() {
            const vFOV = THREE.MathUtils.degToRad(camera.fov);
            const height = 2 * Math.tan(vFOV / 2) * camera.position.z;
            const width = height * camera.aspect;
            return { w: width, h: height };
        }
        let bounds = getBounds();

        // --- COMBAT ACTIONS ---
        function fireLaser() {
            if (!gameActive) return;
            const bullet = new THREE.Mesh(
                new THREE.BoxGeometry(0.1, 0.1, 1),
                new THREE.MeshBasicMaterial({color: 0xff00ff})
            );
            bullet.position.set(ship.position.x, ship.position.y, ship.position.z - 1);
            scene.add(bullet);
            bullets.push(bullet);
        }

        function spawnEnemy(now) {
            if (now - lastEnemy < 2500) return;
            lastEnemy = now;
            const enemy = new THREE.Mesh(
                new THREE.ConeGeometry(0.6, 1.5, 4),
                new THREE.MeshPhongMaterial({color: 0xff3131})
            );
            enemy.rotation.x = Math.PI / 2;
            enemy.position.set((Math.random()-0.5)*bounds.w, (Math.random()-0.5)*bounds.h, -100);
            scene.add(enemy);
            enemies.push(enemy);
        }

        // --- INPUT ---
        function move(e) {
            if (!gameActive) return;
            const rect = container.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            const nx = ((touch.clientX - rect.left) / rect.width) * 2 - 1;
            const ny = -((touch.clientY - rect.top) / rect.height) * 2 + 1;
            ship.position.x = nx * (bounds.w / 2);
            ship.position.y = ny * (bounds.h / 2);
            ship.rotation.z = -nx * 0.4;
        }

        container.addEventListener('mousemove', move);
        container.addEventListener('touchmove', (e) => { 
            if(e.target !== fireBtn) move(e); 
        }, {passive: false});

        // --- MAIN LOOP ---
        function update(now) {
            if (!gameActive) return;

            // 1. Update Bullets (move forward)
            for (let i = bullets.length - 1; i >= 0; i--) {
                bullets[i].position.z -= 2;
                if (bullets[i].position.z < -100) {
                    scene.remove(bullets[i]);
                    bullets.splice(i, 1);
                }
            }

            // 2. Update Enemies (move toward player)
            for (let i = enemies.length - 1; i >= 0; i--) {
                const e = enemies[i];
                e.position.z += 0.8;

                // Check collision with player
                if (e.position.distanceTo(ship.position) < 1) {
                    hit();
                    scene.remove(e); enemies.splice(i, 1);
                    continue;
                }

                // Check collision with bullets
                for (let j = bullets.length - 1; j >= 0; j--) {
                    if (e.position.distanceTo(bullets[j].position) < 1.5) {
                        score++;
                        scoreEl.innerText = `KILLS: ${score}`;
                        scene.remove(e); enemies.splice(i, 1);
                        scene.remove(bullets[j]); bullets.splice(j, 1);
                        break;
                    }
                }

                if (e.position.z > 12) { scene.remove(e); enemies.splice(i, 1); }
            }

            spawnEnemy(now);
            renderer.render(scene, camera);
            requestAnimationFrame(update);
        }

        function hit() {
            lives--;
            livesEl.innerText = `SHIELDS: ${lives}`;
            if (lives <= 0) endGame();
        }

        function startGame() {
            gameActive = true;
            lives = 3; score = 0;
            livesEl.innerText = 'SHIELDS: 3';
            scoreEl.innerText = 'KILLS: 0';
            startOverlay.style.display = 'none';
            fireBtn.style.display = 'flex';
            requestAnimationFrame(update);
        }

        function endGame() {
            gameActive = false;
            fireBtn.style.display = 'none';
            alert("SHIP DESTROYED - KILLS: " + score);
            location.reload();
        }

        function restart() { location.reload(); }

        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
            bounds = getBounds();
        });
    </script>
</body>
</html>
