<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Neon Star Racer | Precision Survival</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        :root { --pink: #ff00ff; --cyan: #00e0ff; --red: #ff3131; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; overflow: hidden; height: 100vh; display: flex; justify-content: center; align-items: center; }
        
        #gameContainer {
            position: relative;
            width: 100vw; height: 100vh;
            max-width: 500px; max-height: 900px;
            border: 4px solid var(--cyan);
            background: #05050a;
            touch-action: none;
        }

        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 20; padding: 20px; display: flex; justify-content: space-between; font-family: 'VT323', monospace; }
        .stat { font-size: 2rem; text-shadow: 0 0 10px rgba(0,224,255,0.5); }
        
        .overlay { 
            position: absolute; inset: 0; z-index: 50; background: rgba(0,0,0,0.92);
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; 
            padding: 20px;
        }
        
        .btn {
            background: none; border: 2px solid var(--pink); color: var(--pink);
            padding: 15px 40px; font-family: 'VT323', monospace; font-size: 2rem;
            cursor: pointer; box-shadow: 0 0 15px var(--pink); margin: 20px;
            transition: all 0.2s;
        }
        .btn:hover { background: var(--pink); color: #000; box-shadow: 0 0 25px var(--pink); }

        #winOverlay h1 { color: var(--cyan); font-size: 3.2rem; margin-bottom: 15px; text-shadow: 0 0 20px var(--cyan); }
        #winOverlay p { color: #fff; font-size: 1.8rem; margin-bottom: 30px; }

        #videoOverlay { background: #000; }
        #rewardVideo { width: 100%; height: 100%; }
        #skipBtn {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,0,0,0.6); border: 2px solid var(--cyan);
            color: var(--cyan); padding: 10px 20px; font-size: 1.5rem;
            z-index: 100; cursor: pointer;
        }
    </style>
</head>
<body>

<div id="gameContainer">
    <div id="ui">
        <div id="lives" class="stat" style="color:var(--red)">SHIELDS: 3</div>
        <div id="timer" class="stat" style="color:var(--cyan)">60s</div>
    </div>

    <!-- Start overlay -->
    <div id="startOverlay" class="overlay">
        <h1 style="color:var(--cyan); font-size:3rem; margin-bottom:20px;">SURVIVE 60 SECONDS</h1>
        <button class="btn" onclick="startGame()">ENGINE START</button>
    </div>

    <!-- Win overlay -->
    <div id="winOverlay" class="overlay" style="display:none;">
        <h1>You survived Tatooine Airspace</h1>
        <p style="color:var(--pink); font-size:2.2rem;">MISSION ACCOMPLISHED</p>
        <button class="btn" onclick="showRewardVideo()">Continue</button>
    </div>

    <!-- Video reward overlay (now unmuted) -->
    <div id="videoOverlay" class="overlay" style="display:none;">
        <button id="skipBtn" onclick="restart()">Skip</button>
        <iframe 
            id="rewardVideo" 
            src="https://www.youtube.com/embed/B7FMh3YtK_w?autoplay=1&enablejsapi=1" 
            frameborder="0" 
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
            allowfullscreen>
        </iframe>
    </div>

    <canvas id="gameCanvas"></canvas>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    const canvas = document.getElementById('gameCanvas');
    const container = document.getElementById('gameContainer');
    const timerEl = document.getElementById('timer');
    const livesEl = document.getElementById('lives');
    const startOverlay = document.getElementById('startOverlay');
    const winOverlay = document.getElementById('winOverlay');
    const videoOverlay = document.getElementById('videoOverlay');

    let gameActive = false, timeLeft = 60, lives = 3, obstacles = [], lastSpawn = 0;
    let timerInterval = null;
    
    // Three.js setup (unchanged)
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    camera.position.z = 10;

    const ship = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(1, 0.3, 1.5), new THREE.MeshPhongMaterial({color: 0x555555}));
    const wingL = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 1.2), new THREE.MeshPhongMaterial({color: 0x222222}));
    wingL.position.set(-1.2, 0, 0.2); wingL.rotation.x = Math.PI/2;
    const wingR = wingL.clone(); wingR.position.x = 1.2;
    ship.add(body, wingL, wingR);
    scene.add(ship);
    scene.add(new THREE.AmbientLight(0xffffff, 1));

    function getBounds() {
        const vFOV = THREE.MathUtils.degToRad(camera.fov);
        const height = 2 * Math.tan(vFOV / 2) * camera.position.z;
        const width = height * camera.aspect;
        return { x: (width / 2) - 1.5, y: (height / 2) - 1.0 };
    }
    let bounds = getBounds();

    function spawnLaser(now) {
        if (now - lastSpawn < 2000) return;
        lastSpawn = now;

        const colors = [0xff00ff, 0x00e0ff, 0x39ff14, 0xffff00];
        const color = colors[Math.floor(Math.random() * colors.length)];
        const laser = new THREE.Mesh(
            new THREE.BoxGeometry(30, 0.3, 0.3), 
            new THREE.MeshBasicMaterial({color: color})
        );
        laser.position.set(0, (Math.random() - 0.5) * bounds.y * 2, -100);
        scene.add(laser);
        obstacles.push(laser);
    }

    function update(now) {
        if (!gameActive) return;

        for (let i = obstacles.length - 1; i >= 0; i--) {
            const o = obstacles[i];
            o.position.z += 0.8;

            const shipBox = new THREE.Box3().setFromObject(ship);
            const laserBox = new THREE.Box3().setFromObject(o);
            if (shipBox.intersectsBox(laserBox)) {
                lives--;
                livesEl.innerText = `SHIELDS: ${lives}`;
                scene.remove(o);
                obstacles.splice(i, 1);
                if (lives <= 0) restart();
                continue;
            }

            if (o.position.z > 12) {
                scene.remove(o);
                obstacles.splice(i, 1);
            }
        }

        spawnLaser(now);
        renderer.render(scene, camera);
        requestAnimationFrame(update);
    }

    const move = (e) => {
        if (!gameActive) return;
        const rect = container.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : e;
        
        const px = (touch.clientX - rect.left) / rect.width;
        const py = (touch.clientY - rect.top) / rect.height;

        ship.position.x = (px * 2 - 1) * bounds.x;
        ship.position.y = -(py * 2 - 1) * bounds.y;

        ship.rotation.z = -ship.position.x * 0.1;
        ship.rotation.x = -ship.position.y * 0.05;
    };

    container.addEventListener('mousemove', move);
    container.addEventListener('touchmove', (e) => { e.preventDefault(); move(e); }, {passive:false});

    function startGame() {
        gameActive = true; lives = 3; timeLeft = 60;
        livesEl.innerText = `SHIELDS: 3`;
        timerEl.innerText = `60s`;
        startOverlay.style.display = 'none';
        winOverlay.style.display = 'none';
        videoOverlay.style.display = 'none';
        obstacles.forEach(o => scene.remove(o));
        obstacles = [];

        timerInterval = setInterval(() => {
            if (!gameActive) { clearInterval(timerInterval); return; }
            timeLeft--;
            timerEl.innerText = `${timeLeft}s`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                gameActive = false;
                winOverlay.style.display = 'flex';
            }
        }, 1000);

        requestAnimationFrame(update);
    }

    function showRewardVideo() {
        winOverlay.style.display = 'none';
        videoOverlay.style.display = 'flex';

        const iframe = document.getElementById('rewardVideo');
        // YouTube IFrame API listener for end detection
        window.addEventListener('message', (event) => {
            if (event.origin.includes('youtube.com') && event.data.event === 'onStateChange') {
                if (event.data.info === 0) { // YT.PlayerState.ENDED
                    restart();
                }
            }
        });
    }

    function restart() {
        gameActive = false;
        clearInterval(timerInterval);
        location.reload();
    }

    window.addEventListener('resize', () => {
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
        bounds = getBounds();
    });
</script>
</body>
</html>
